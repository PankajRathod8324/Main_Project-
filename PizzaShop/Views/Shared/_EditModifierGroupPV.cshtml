@model DAL.ViewModel.MenuModifierGroupVM

<form id="editModifierGroupForm">
    <div class="modal-body">
        <input type="hidden" asp-for="ModifierGroupId">

        <div class="form-floating mb-3">
            <input type="text" asp-for="ModifierGroupName" class="form-control">
            <label asp-for="ModifierGroupName">Name*</label>
        </div>

        <div class="form-outline mb-4">
            <textarea class="form-control" asp-for="ModifierGroupDecription" rows="4"></textarea>
        </div>

        <div class="mb-3">
            <h6>Selected Modifiers:</h6>
            <div id="selectedModifiersList" class="d-flex flex-wrap gap-2">
                @foreach (var modifier in Model.ModifierIds)
                {
                    <div class="border border-dark rounded px-3 py-1 d-flex align-items-center bg-light me-2"
                        data-id="@modifier">
                        <span class="me-2">@modifier</span>
                        <span class="text-danger remove-modifier" style="cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </span>
                    </div>
                }
            </div>
            <input type="hidden" asp-for="ModifierIds">
        </div>

        <!-- Button to Add Modifier -->
        <button type="button" class="btn btn-outline-primary mt-2"  data-bs-toggle="modal" data-bs-target="#editAllModifiersModal" id="addModifierBtn">
            <i class="fas fa-plus"></i> Add Modifier
        </button>
    </div>
</form>

<!-- Modifier Selection Modal -->
<div class="modal" id="editAllModifiersModal" tabindex="-1" aria-labelledby="allModifiersLabel" aria-hidden="true">
    <div class="modal-dialog  modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="allModifiersLabel">Select Modifiers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <input type="text" id="searchQuery" class="form-control mb-3" placeholder="Search Modifier">
                <div id="modifierPartialContainer"></div> <!-- Partial View Container -->
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="addSelectedModifiers">Add Selected</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).on('click', '#addModifierBtn', function () {
        const alreadyOpen = $('.modal.show');
        console.log('Already Open:');
        if (alreadyOpen.length > 0) {
            const modalInstance = $(alreadyOpen).modal('hide');

            if (modalInstance) {
                modalInstance.hide();
                alreadyOpen.on('hidden.bs.modal', function () {
                    $('#editAllModifiersModal').modal('show');
                });
                return;
            }
        }

        $.ajax({
            url: `/Menu/GetAllModifier`,
            type: 'GET',
            success: function (data) {
                $('#modifierPartialContainer').html(data);
                $('#editAllModifiersModal').modal('show');
            },
            error: function (xhr) {
                console.error('Error fetching add modifier partial:', xhr.responseText);
            }
        });
    });

    // Save Selected Modifiers
    $(document).on('click', '#addSelectedModifiers', function () {
        let selectedModifiers = [];

        $('.modifier-checkbox:checked').each(function () {
            selectedModifiers.push({
                id: $(this).val(),
                name: $(this).next('label').text().trim()
            });
        });

        console.log("Selected Modifiers:", selectedModifiers);

        // Update the main modal with selected modifiers
        let selectedHtml = "";
        selectedModifiers.forEach(modifier => {
            selectedHtml += `
                <div class="border border-dark rounded px-3 py-1 d-flex align-items-center bg-light me-2" data-id="${modifier.id}">
                    <span class="me-2">${modifier.name}</span>
                    <span class="text-danger remove-modifier" style="cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            `;
        });

        $('#selectedModifiersList').html(selectedHtml);
        $('#ModifierIds').val(selectedModifiers.map(m => m.id).join(',')); // Update hidden input

        $('#editAllModifiersModal').modal('hide'); // Close modal properly
    });

    // Remove selected modifier
    $(document).on('click', '.remove-modifier', function () {
        $(this).closest('div').remove();
        updateHiddenModifierIds();
    });

    function updateHiddenModifierIds() {
        let selectedModifiers = [];
        $('#selectedModifiersList div').each(function () {
            selectedModifiers.push($(this).attr('data-id'));
        });
        $('#ModifierIds').val(selectedModifiers.join(','));
    }
</script>
